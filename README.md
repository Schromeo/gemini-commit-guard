# Gemini Commit Guard - V1 (Proof of Concept)

这是一个基于 Google Gemini CLI 的智能 Git pre-commit 钩子，它可以在你 `git commit` 时对你的代码进行“语义分析”，防止潜在的 Bug 被提交。

## 灵感来源

传统的commit-push就是git add . 然后git commit -m "Hey this is a commit", 然后git push
结果compile成功，但是push之后污染了代码库，因为有隐形的bug，
接下来只能回退，并且在本地疯狂找bug，
好无趣，好无聊；
而这个hook可以在commit指令触发的时候调用gemini进行语义分析，好好玩
老板再也不担心潜在的bug污染代码库了！


## V1 (POC) 成果

我们成功跑通了 "git commit -> 触发脚本 -> Gemini API 分析 -> 成功拦截危险提交" 的黄金路线！

**成功拦截：**
🚨🚨🚨 [Gemini Guard] 提交被中止！🚨🚨🚨
AI 检测到潜在的语义冲突或风险：
----------------------------------------
[警告]
本次代码变更引入了严重的安全漏洞和潜在的运行时错误。

1.  **安全风险 (SQL注入)**: `dangerous_code.py` 文件中的 `connect_to_db` 函数通过直接拼接字符串构建SQL查询，这会造成严重SQL注入漏洞。攻击者可以利用此漏洞执行任意数据库操作，导致数据泄露、篡改或删除。必须使用参数化查询或ORM来修复此问题。

2.  **潜在的运行时错误**: `connect_to_db` 函数中使用了未定义的变量 `db`。在未进行初始化和连接的情况下调用 `db.execute()` 会导致程序崩溃。

3.  **语义冲突与高风险函数**: `delete_everything` 函数的命名具有极高的风险。即使目前为空实现，其名称也暗示了大规模的破坏性操作。这种函数不仅容易被误用，而且其通用名称很可能在未来与其他模块的功能产生命 名冲突，从而引发不可预见的严重Bug。建议将其重命名或彻底移除。
----------------------------------------
请审查你的代码后再次尝试提交。

---

## V1 核心脚本 (pre-commit)

这是我们 V1 的核心脚本。

**注意：** 目前 (V1)，你需要手动把它复制到你本地项目的 `.git/hooks/` 文件夹下，并确保它有 Unix 换行符 (LF) 并且 `chmod +x`。

```sh
#!/bin/sh
echo "🤖 [Gemini Guard] 正在启动语义分析..."

# 1. 获取所有暂存的 (staged) 代码改动
STAGED_DIFF=$(git diff --staged)

# 2. 如果没有改动，就跳过
if [ -z "$STAGED_DIFF" ]; then
    echo "🤖 [Gemini Guard] 没有检测到代码改动。"
    exit 0
fi

# ----------------------------------------------------
# 核心 Prompt - 我们在这里定义AI的角色和任务
# ----------------------------------------------------
PROMPT="""
你是一个资深的Google软件架构师，你的任务是分析代码变更并防止潜在的Bug。

这是我即将提交的代码改动（git diff格式）：
---
$STAGED_DIFF
---

请基于这份 diff，分析以下问题：
1. **语义冲突**：这个改动是否有可能与项目中的其他部分产生逻辑冲突或运行时Bug？
2. **潜在风险**：是否存在任何隐藏的风险、性能问题或未处理的边缘情况？

你的回答必须遵循以下格式：
* 如果**没有发现任何问题**，请只回答：**[通过]**
* 如果**发现任何问题或风险**，请以 **[警告]** 开头，然后详细说明你的担忧。
"""

# ----------------------------------------------------
# 调用 Gemini CLI 并分析结果
# ----------------------------------------------------
# 我们将 PROMPT 通过管道传给 gemini-cli
ANALYSIS_RESULT=$(echo "$PROMPT" | gemini)

# 关键：检查 AI 的输出是否包含 "[警告]"
if echo "$ANALYSIS_RESULT" | grep -q "\[警告\]"; then
    # 5. 发现问题：打印警告并中止提交
    echo ""
    echo "🚨🚨🚨 [Gemini Guard] 提交被中止！🚨🚨🚨"
    echo "AI 检测到潜在的语义冲突或风险："
    echo "----------------------------------------"
    echo "$ANALYSIS_RESULT"
    echo "----------------------------------------"
    echo "请审查你的代码后再次尝试提交。"
    exit 1 # <--- 非零退出，中止提交！
else
    # 6. 一切正常：允许提交
    echo "✅ [Gemini Guard] 语义分析通过。正在提交..."
    exit 0 # <--- 零退出，继续提交！
fi

...
